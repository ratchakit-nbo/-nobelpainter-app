<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painter PC - WiFi Mode</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary-bg: #1a1a1a; --toolbar-bg: #ffffff; --accent: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--primary-bg); overflow: hidden; }
        #toolbar { background: var(--toolbar-bg); padding: 12px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10; }
        .conn-box { background: #f0f4f8; padding: 6px 15px; border-radius: 20px; border: 1px solid #d1d9e0; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        #my-id { font-weight: bold; color: var(--accent); background: white; padding: 2px 8px; border-radius: 4px; border: 1px solid #ddd; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #ccc; }
        .online { background: #28a745; box-shadow: 0 0 8px #28a745; }
        #canvas-wrap { flex-grow: 1; position: relative; display: flex; background: #333; justify-content: center; align-items: center; }
        canvas { background: white; cursor: crosshair; box-shadow: 0 0 30px rgba(0,0,0,0.5); touch-action: none; }
        #score-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; }
        .score-card { background: white; padding: 40px; border-radius: 30px; text-align: center; min-width: 320px; }
        #btn-finish { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; border: none; padding: 18px 50px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 20px; display: none; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="conn-box">
            <div id="status-dot" class="status-dot"></div>
            <span>ID: <span id="my-id">...</span></span>
        </div>
        <select id="template-select" style="padding:8px; border-radius:5px;">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö --</option>
        </select>
        <button onclick="undo()">‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button onclick="clearCanvas()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≠</button>
    </div>

    <div id="canvas-wrap">
        <div id="score-overlay">
            <div class="score-card">
                <h2>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h2>
                <div id="score-val" style="font-size: 100px; font-weight: bold; color: #28a745;">0</div>
                <button onclick="closeScore()" style="padding:12px 40px; cursor:pointer; background:var(--accent); color:white; border:none; border-radius:10px;">‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠</button>
            </div>
        </div>
        <button id="btn-finish" onclick="sendToTablet()">‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà 4G Tablet üöÄ</button>
        <canvas id="paintCanvas" width="700" height="700"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('paintCanvas'), ctx = canvas.getContext('2d');
        const templateSelect = document.getElementById('template-select'), btnFinish = document.getElementById('btn-finish');
        let drawing = false, undoStack = [], conn = null;

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Å (WiFi <-> 4G) ---
        const peer = new Peer({
            config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]}
        });

        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => {
            conn = c;
            document.getElementById('status-dot').classList.add('online');
            conn.on('data', data => {
                if(data.score !== undefined) {
                    document.getElementById('score-overlay').style.display = 'flex';
                    document.getElementById('score-val').innerText = data.score;
                }
            });
        });

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏î
        ctx.fillStyle = "white"; ctx.fillRect(0,0,700,700);
        function getPos(e) { 
            const r = canvas.getBoundingClientRect(); 
            return { x: e.clientX - r.left, y: e.clientY - r.top }; 
        }
        canvas.onmousedown = (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        window.onmousemove = (e) => {
            if(!drawing) return;
            const p = getPos(e);
            ctx.lineWidth = 10; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
            ctx.lineTo(p.x, p.y); ctx.stroke();
        };
        window.onmouseup = () => { if(drawing) { drawing = false; save(); } };

        const animals = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ"];
        animals.forEach(a => { const opt = document.createElement('option'); opt.value = a; opt.textContent = a; templateSelect.appendChild(opt); });

        templateSelect.onchange = () => {
            ctx.fillStyle = "white"; ctx.fillRect(0,0,700,700);
            const val = templateSelect.value;
            if(val) {
                ctx.save(); ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font="500px Arial";
                ctx.fillStyle="rgba(0,0,0,0.06)"; ctx.fillText(val, 350, 350); ctx.restore();
                btnFinish.style.display = 'block';
            }
            save();
        };

        function save() { undoStack.push(ctx.getImageData(0,0,700,700)); if(undoStack.length > 20) undoStack.shift(); }
        function undo() { if(undoStack.length > 1) { undoStack.pop(); ctx.putImageData(undoStack[undoStack.length-1], 0,0); } }
        function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0,0,700,700); templateSelect.onchange(); }
        function closeScore() { document.getElementById('score-overlay').style.display = 'none'; clearCanvas(); }

        function sendToTablet() {
            if(!conn || !conn.open) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï!");
            conn.send({ image: canvas.toDataURL('image/jpeg', 0.5), char: templateSelect.value });
            alert("‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡∏ó‡∏µ‡πà 4G Tablet ‡πÅ‡∏•‡πâ‡∏ß!");
        }
    </script>
</body>
</html>